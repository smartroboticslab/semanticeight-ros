#!/bin/sh
# SPDX-FileCopyrightText: 2022 Smart Robotics Lab, Imperial College London
# SPDX-FileCopyrightText: 2022 Sotiris Papatheodorou
# SPDX-License-Identifier: CC0-1.0
set -eu

usage() {
	printf 'Usage: %s DIR ...\n' "${0##*/}"
}

mesh_comparison_log() {
	find -L "$@" -type f -path '*/meshes/mesh_comparison.log'
}

mesh_comparison_tsv() {
	find -L "$@" -type f -path '*/meshes/mesh_comparison.tsv'
}

mesh_stats() {
	# https://git.sr.ht/~sotirisp/dots/blob/master/.local/bin/tsvavg
	# shellcheck disable=SC2046
	mesh_tsvs=$(mesh_comparison_tsv "$@")
	if [ -n "$mesh_tsvs" ]
	then
		tsvavg -a $mesh_tsvs | cut -f 4,5,7,8 | column -t -s '	'
	fi
}



if [ "$#" -eq 0 ]
then
	usage
	exit 2
fi

. "$(dirname "$0")/lib.sh"

num_runs=$(mesh_comparison_tsv "$@" | wc -l)
if [ "$num_runs" -gt 1 ]
then
	printf 'Data averaged over %d runs\n' "$num_runs"
fi
objects_found $(mesh_comparison_log "$@")
mesh_stats "$@"
